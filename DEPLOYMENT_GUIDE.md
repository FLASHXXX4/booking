# Laravel Hotel Booking System - Deployment Guide

This guide will walk you through deploying your Laravel application to a production web server.

## Table of Contents
1. [Server Requirements](#server-requirements)
2. [Server Setup](#server-setup)
3. [Uploading Your Project](#uploading-your-project)
4. [Environment Configuration](#environment-configuration)
5. [Database Setup](#database-setup)
6. [File Permissions](#file-permissions)
7. [Web Server Configuration](#web-server-configuration)
8. [Domain Configuration](#domain-configuration)
9. [Security Hardening](#security-hardening)
10. [Performance Optimization](#performance-optimization)
11. [Troubleshooting](#troubleshooting)

---

## Server Requirements

### Minimum Requirements
- **PHP:** 8.2 or higher
- **MySQL:** 5.7+ or MariaDB 10.3+
- **Composer:** Latest version
- **Node.js & NPM:** For asset compilation
- **Web Server:** Apache 2.4+ or Nginx 1.18+
- **RAM:** 1GB minimum (2GB+ recommended)
- **Storage:** 5GB+ free space

### Required PHP Extensions
```bash
php -m | grep -E "pdo|mysql|sqlite|mbstring|xml|curl|zip|gd|fileinfo|openssl|tokenizer|json|bcmath"
```

Required extensions:
- `pdo_mysql` or `pdo_sqlite`
- `mbstring`
- `xml`
- `curl`
- `zip`
- `gd` (optional, for image processing)
- `fileinfo`
- `openssl`
- `tokenizer`
- `json`
- `bcmath`

---

## Server Setup

### Step 1: Update System Packages

**Ubuntu/Debian:**
```bash
sudo apt update
sudo apt upgrade -y
```

**CentOS/RHEL:**
```bash
sudo yum update -y
```

### Step 2: Install PHP and Extensions

**Ubuntu/Debian:**
```bash
sudo apt install -y php8.2 php8.2-cli php8.2-fpm php8.2-mysql php8.2-mbstring \
    php8.2-xml php8.2-curl php8.2-zip php8.2-gd php8.2-bcmath php8.2-sqlite3
```

**CentOS/RHEL:**
```bash
sudo yum install -y php82 php82-php-fpm php82-php-mysqlnd php82-php-mbstring \
    php82-php-xml php82-php-curl php82-php-zip php82-php-gd php82-php-bcmath
```

Verify installation:
```bash
php -v
php -m
```

### Step 3: Install MySQL/MariaDB

**Ubuntu/Debian:**
```bash
sudo apt install -y mysql-server
sudo mysql_secure_installation
```

**CentOS/RHEL:**
```bash
sudo yum install -y mariadb-server mariadb
sudo systemctl start mariadb
sudo systemctl enable mariadb
sudo mysql_secure_installation
```

### Step 4: Install Composer

```bash
cd ~
curl -sS https://getcomposer.org/installer | php
sudo mv composer.phar /usr/local/bin/composer
sudo chmod +x /usr/local/bin/composer
composer --version
```

### Step 5: Install Node.js and NPM

**Using NodeSource (Recommended):**
```bash
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs
```

Or using NVM:
```bash
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 20
nvm use 20
```

Verify:
```bash
node -v
npm -v
```

### Step 6: Install Web Server

**Option A: Apache**
```bash
sudo apt install -y apache2
sudo systemctl start apache2
sudo systemctl enable apache2
```

**Option B: Nginx (Recommended for Laravel)**
```bash
sudo apt install -y nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

---

## Uploading Your Project

### Method 1: Using Git (Recommended)

```bash
cd /var/www
sudo git clone https://github.com/yourusername/your-repo.git booking
cd booking
```

### Method 2: Using SCP/SFTP

From your local machine:
```bash
# Compress the project (exclude node_modules, vendor, .git)
tar -czf booking.tar.gz --exclude='node_modules' --exclude='vendor' --exclude='.git' booking/

# Upload via SCP
scp booking.tar.gz user@your-server-ip:/tmp/

# On server, extract
ssh user@your-server-ip
cd /var/www
sudo tar -xzf /tmp/booking.tar.gz
sudo mv booking /var/www/booking
```

### Method 3: Using FTP/SFTP Client
- Use FileZilla, WinSCP, or similar
- Upload all files to `/var/www/booking`
- Exclude: `node_modules`, `vendor`, `.git`, `.env`

### Set Ownership
```bash
sudo chown -R www-data:www-data /var/www/booking
# Or if using a specific user:
sudo chown -R $USER:www-data /var/www/booking
```

---

## Environment Configuration

### Step 1: Copy .env File

```bash
cd /var/www/booking
cp .env.example .env
```

### Step 2: Generate Application Key

```bash
php artisan key:generate
```

### Step 3: Configure .env File

Edit `.env` file:
```bash
nano .env
```

**Important Settings:**

```env
APP_NAME="Booking"
APP_ENV=production
APP_KEY=base64:... (generated by artisan key:generate)
APP_DEBUG=false
APP_URL=https://yourdomain.com

# Database Configuration
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=booking_db
DB_USERNAME=booking_user
DB_PASSWORD=your_secure_password_here

# Cache & Session
CACHE_DRIVER=file
SESSION_DRIVER=database
QUEUE_CONNECTION=database

# Mail Configuration (if needed)
MAIL_MAILER=smtp
MAIL_HOST=smtp.mailtrap.io
MAIL_PORT=2525
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_ENCRYPTION=null
MAIL_FROM_ADDRESS="noreply@yourdomain.com"
MAIL_FROM_NAME="${APP_NAME}"
```

**Security Notes:**
- Set `APP_DEBUG=false` in production
- Use strong database passwords
- Never commit `.env` to version control

---

## Database Setup

### Step 1: Create Database and User

```bash
sudo mysql -u root -p
```

In MySQL:
```sql
CREATE DATABASE booking_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'booking_user'@'localhost' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON booking_db.* TO 'booking_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### Step 2: Install Dependencies

```bash
cd /var/www/booking
composer install --optimize-autoloader --no-dev
npm install
npm run build
```

### Step 3: Run Migrations and Seeders

```bash
php artisan migrate --force
php artisan db:seed --force
```

**Note:** `--force` flag is required in production environment.

---

## File Permissions

### Set Correct Permissions

```bash
cd /var/www/booking

# Set ownership
sudo chown -R www-data:www-data /var/www/booking

# Set directory permissions
sudo find /var/www/booking -type d -exec chmod 755 {} \;

# Set file permissions
sudo find /var/www/booking -type f -exec chmod 644 {} \;

# Special permissions for storage and bootstrap/cache
sudo chmod -R 775 storage bootstrap/cache
sudo chown -R www-data:www-data storage bootstrap/cache
```

### Verify Permissions

```bash
ls -la storage/
ls -la bootstrap/cache/
```

Both should show `www-data` as owner and `775` permissions.

---

## Web Server Configuration

### Option A: Apache Configuration

#### 1. Enable Required Modules

```bash
sudo a2enmod rewrite
sudo a2enmod ssl
sudo systemctl restart apache2
```

#### 2. Create Virtual Host

```bash
sudo nano /etc/apache2/sites-available/booking.conf
```

Add configuration:
```apache
<VirtualHost *:80>
    ServerName yourdomain.com
    ServerAlias www.yourdomain.com
    
    DocumentRoot /var/www/booking/public
    
    <Directory /var/www/booking/public>
        AllowOverride All
        Require all granted
    </Directory>
    
    ErrorLog ${APACHE_LOG_DIR}/booking_error.log
    CustomLog ${APACHE_LOG_DIR}/booking_access.log combined
</VirtualHost>
```

#### 3. Enable Site and Restart

```bash
sudo a2ensite booking.conf
sudo a2dissite 000-default.conf
sudo systemctl restart apache2
```

### Option B: Nginx Configuration (Recommended)

#### 1. Create Nginx Configuration

```bash
sudo nano /etc/nginx/sites-available/booking
```

Add configuration:
```nginx
server {
    listen 80;
    listen [::]:80;
    server_name yourdomain.com www.yourdomain.com;
    root /var/www/booking/public;
    
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";
    
    index index.php;
    
    charset utf-8;
    
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
    
    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }
    
    error_page 404 /index.php;
    
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }
    
    location ~ /\.(?!well-known).* {
        deny all;
    }
}
```

#### 2. Enable Site and Test

```bash
sudo ln -s /etc/nginx/sites-available/booking /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

---

## Domain Configuration

### Step 1: Point Domain to Server

1. **Get your server IP:**
   ```bash
   curl ifconfig.me
   ```

2. **Configure DNS:**
   - Go to your domain registrar (GoDaddy, Namecheap, etc.)
   - Add/Edit DNS records:
     - **A Record:** `@` → Your server IP
     - **A Record:** `www` → Your server IP
   - Wait for DNS propagation (can take up to 48 hours, usually 1-2 hours)

### Step 2: Verify DNS

```bash
nslookup yourdomain.com
ping yourdomain.com
```

### Step 3: Update APP_URL in .env

```env
APP_URL=https://yourdomain.com
```

---

## Security Hardening

### 1. Firewall Configuration

**UFW (Ubuntu):**
```bash
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable
```

**Firewalld (CentOS):**
```bash
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --reload
```

### 2. SSL/HTTPS Setup (Let's Encrypt)

**Install Certbot:**
```bash
sudo apt install -y certbot python3-certbot-nginx
# Or for Apache:
sudo apt install -y certbot python3-certbot-apache
```

**Get SSL Certificate:**
```bash
# For Nginx
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com

# For Apache
sudo certbot --apache -d yourdomain.com -d www.yourdomain.com
```

**Auto-renewal:**
```bash
sudo certbot renew --dry-run
```

### 3. Secure .env File

```bash
chmod 600 /var/www/booking/.env
chown www-data:www-data /var/www/booking/.env
```

### 4. Hide Server Information

Edit `config/app.php`:
```php
'debug' => env('APP_DEBUG', false),
```

### 5. Disable Directory Listing

**Apache:** Already disabled by default
**Nginx:** Add to server block:
```nginx
autoindex off;
```

### 6. Secure Database

```sql
-- Remove test databases
DROP DATABASE IF EXISTS test;
DELETE FROM mysql.user WHERE User='';
FLUSH PRIVILEGES;
```

### 7. Regular Updates

```bash
# Update system packages
sudo apt update && sudo apt upgrade -y

# Update Composer packages
cd /var/www/booking
composer update --no-dev

# Update NPM packages
npm update
```

---

## Performance Optimization

### 1. Enable OPcache

Edit `php.ini`:
```bash
sudo nano /etc/php/8.2/fpm/php.ini
```

Uncomment/modify:
```ini
opcache.enable=1
opcache.memory_consumption=128
opcache.interned_strings_buffer=8
opcache.max_accelerated_files=10000
opcache.revalidate_freq=2
opcache.fast_shutdown=1
```

Restart PHP:
```bash
sudo systemctl restart php8.2-fpm
```

### 2. Laravel Optimization

```bash
cd /var/www/booking

# Cache configuration
php artisan config:cache

# Cache routes
php artisan route:cache

# Cache views
php artisan view:cache

# Optimize autoloader
composer install --optimize-autoloader --no-dev
```

### 3. Database Optimization

**Add indexes (if needed):**
```sql
ALTER TABLE hotels ADD INDEX idx_city (city);
ALTER TABLE hotels ADD INDEX idx_price (price_per_night);
ALTER TABLE reservations ADD INDEX idx_user (user_id);
ALTER TABLE reservations ADD INDEX idx_hotel (hotel_id);
```

### 4. Enable Gzip Compression

**Nginx:**
Add to server block:
```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;
```

**Apache:**
```bash
sudo a2enmod deflate
sudo systemctl restart apache2
```

### 5. Use CDN for Assets (Optional)

Consider using CloudFlare or AWS CloudFront for static assets.

### 6. Queue Jobs (For Future)

If using queues:
```bash
# Install supervisor
sudo apt install supervisor

# Create queue worker config
sudo nano /etc/supervisor/conf.d/laravel-worker.conf
```

---

## Maintenance Commands

### Daily/Weekly Tasks

```bash
# Clear cache
php artisan cache:clear
php artisan config:clear
php artisan route:clear
php artisan view:clear

# Re-optimize
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Backup database
mysqldump -u booking_user -p booking_db > backup_$(date +%Y%m%d).sql
```

### Create Backup Script

```bash
sudo nano /usr/local/bin/backup-booking.sh
```

```bash
#!/bin/bash
BACKUP_DIR="/var/backups/booking"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR

# Backup database
mysqldump -u booking_user -p'your_password' booking_db > $BACKUP_DIR/db_$DATE.sql

# Backup files
tar -czf $BACKUP_DIR/files_$DATE.tar.gz /var/www/booking

# Keep only last 7 days
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete
```

Make executable:
```bash
sudo chmod +x /usr/local/bin/backup-booking.sh
```

Add to crontab:
```bash
sudo crontab -e
# Add: 0 2 * * * /usr/local/bin/backup-booking.sh
```

---

## Troubleshooting

### Common Issues

#### 1. 500 Internal Server Error

**Check logs:**
```bash
tail -f storage/logs/laravel.log
tail -f /var/log/nginx/error.log  # or /var/log/apache2/error.log
```

**Common fixes:**
- Check file permissions
- Verify .env configuration
- Clear cache: `php artisan config:clear`

#### 2. Permission Denied

```bash
sudo chown -R www-data:www-data /var/www/booking
sudo chmod -R 775 storage bootstrap/cache
```

#### 3. Database Connection Error

- Verify database credentials in `.env`
- Check MySQL is running: `sudo systemctl status mysql`
- Test connection: `mysql -u booking_user -p booking_db`

#### 4. Assets Not Loading

```bash
npm run build
php artisan storage:link  # If using storage for images
```

#### 5. Route Not Found

```bash
php artisan route:clear
php artisan route:cache
```

### Useful Commands

```bash
# Check PHP version
php -v

# Check PHP modules
php -m

# Check disk space
df -h

# Check memory
free -h

# Check running processes
ps aux | grep php
ps aux | grep nginx
```

---

## Post-Deployment Checklist

- [ ] All environment variables configured
- [ ] Database migrated and seeded
- [ ] File permissions set correctly
- [ ] SSL certificate installed
- [ ] Firewall configured
- [ ] `.env` file secured (600 permissions)
- [ ] `APP_DEBUG=false` in production
- [ ] Caching enabled (config, routes, views)
- [ ] OPcache enabled
- [ ] Backup script configured
- [ ] Domain DNS configured
- [ ] Test all major features
- [ ] Monitor error logs

---

## Quick Reference

### Important Paths
- Project: `/var/www/booking`
- Logs: `/var/www/booking/storage/logs/laravel.log`
- Nginx config: `/etc/nginx/sites-available/booking`
- Apache config: `/etc/apache2/sites-available/booking.conf`
- PHP config: `/etc/php/8.2/fpm/php.ini`

### Useful Commands
```bash
# Restart services
sudo systemctl restart nginx
sudo systemctl restart apache2
sudo systemctl restart php8.2-fpm
sudo systemctl restart mysql

# Check service status
sudo systemctl status nginx
sudo systemctl status mysql

# View logs
tail -f storage/logs/laravel.log
tail -f /var/log/nginx/error.log
```

---

## Support & Resources

- **Laravel Documentation:** https://laravel.com/docs
- **Laravel Deployment:** https://laravel.com/docs/deployment
- **Let's Encrypt:** https://letsencrypt.org
- **Nginx Documentation:** https://nginx.org/en/docs/
- **Apache Documentation:** https://httpd.apache.org/docs/

---

**Note:** Always test your deployment in a staging environment before going live!

